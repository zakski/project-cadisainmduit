// Continue with the complete correction function and process batch 7
import Papa from 'papaparse';
const fileContent = await window.fs.readFile('ire_occupation_1901.csv', { encoding: 'utf8' });

const parsedData = Papa.parse(fileContent, {
    header: true,
    skipEmptyLines: true,
    delimitersToGuess: [',', '\t', '|', ';']
});

// Complete correction function with ALL corrections from original script
function correctOccupation(occupation) {
    if (!occupation) return '';

    let corrected = occupation.trim();

    // ENHANCED PREPROCESSING
    // 1. Remove brackets first
    corrected = corrected.replace(/[\[\]()]/g, '');

    // 2. Handle hyphens as whitespace
    corrected = corrected.replace(/-/g, ' ');

    // 3. Condense duplicate whitespace
    corrected = corrected.replace(/\s+/g, ' ').trim();

    // COMPREHENSIVE CORRECTIONS including ALL from original script
    const corrections = {
        // Apostrophe corrections
        "Farmers Son": "Farmer's Son",
        "Farmers Daughter": "Farmer's Daughter",
        "Farmers Wife": "Farmer's Wife",
        "Farmer Son": "Farmer's Son",
        "Farmer Daughter": "Farmer's Daughter",
        "Farmers Sister": "Farmer's Sister",
        "Farmers Brother": "Farmer's Brother",
        "Farmers Nephew": "Farmer's Nephew",
        "Farmers Niece": "Farmer's Niece",
        "Farmers Mother": "Farmer's Mother",
        "Farmers Widow": "Farmer's Widow",
        "Farmers Servant": "Farmer's Servant",
        "Farmers Labourer": "Farmer's Labourer",
        "Farmers Assistant": "Farmer's Assistant",
        "Labourers Wife": "Labourer's Wife",
        "Labourers Daughter": "Labourer's Daughter",
        "Labourers Son": "Labourer's Son",
        "Labourers Widow": "Labourer's Widow",
        "Blacksmiths Assistant": "Blacksmith's Assistant",
        "Butchers Assistant": "Butcher's Assistant",
        "Tailors Assistant": "Tailor's Assistant",
        "Shoemakers Assistant": "Shoemaker's Assistant",
        "Carpenters Assistant": "Carpenter's Assistant",
        "Drapers Assistant": "Draper's Assistant",
        "Grocers Assistant": "Grocer's Assistant",
        "Bakers Assistant": "Baker's Assistant",
        "Soldiers Wife": "Soldier's Wife",
        "Policemans Son": "Policeman's Son",
        "Policemans Wife": "Policeman's Wife",
        "Teachers Daughter": "Teacher's Daughter",
        "Tailors Wife": "Tailor's Wife",
        "Carpenters Wife": "Carpenter's Wife",
        "Carpenters Son": "Carpenter's Son",
        "Carpenters Daughter": "Carpenter's Daughter",
        "Shepherds Son": "Shepherd's Son",
        "Shepherds Daughter": "Shepherd's Daughter",
        "Shepherds Wife": "Shepherd's Wife",
        "Herds Son": "Herd's Son",
        "Herds Daughter": "Herd's Daughter",
        "Herds Wife": "Herd's Wife",
        "Publicans Son": "Publican's Son",
        "Publicans Daughter": "Publican's Daughter",
        "Publicans Wife": "Publican's Wife",
        "Publicans Assistant": "Publican's Assistant",
        "Shopkeepers Son": "Shopkeeper's Son",
        "Shopkeepers Daughter": "Shopkeeper's Daughter",
        "Shop Keepers Daughter": "Shopkeeper's Daughter",
        "Shop Keepers Wife": "Shopkeeper's Wife",
        "Dairymans Son": "Dairyman's Son",
        "Dairymans Daughter": "Dairyman's Daughter",
        "Mill Owners Wife": "Mill Owner's Wife",
        "Fishermans Daughter": "Fisherman's Daughter",
        "Childrens Nurse": "Children's Nurse",
        "Sailors Wife": "Sailor's Wife",
        "Famers Son": "Farmer's Son",
        "Farmers' Son": "Farmer's Son",

        // Combine compound words
        "House Keeper": "Housekeeper",
        "Book Keeper": "Bookkeeper",
        "Shop Keeper": "Shopkeeper",
        "Gate Keeper": "Gatekeeper",
        "Time Keeper": "Timekeeper",
        "Care Taker": "Caretaker",
        "Watch Maker": "Watchmaker",
        "Clock Maker": "Clockmaker",
        "Shoe Maker": "Shoemaker",
        "Dress Maker": "Dressmaker",
        "Cabinet Maker": "Cabinetmaker",
        "Cabnet Maker": "Cabinetmaker",
        "Paper Hanger": "Paperhanger",
        "Stone Mason": "Stonemason",
        "Black Smith": "Blacksmith",
        "Gold Smith": "Goldsmith",
        "Silver Smith": "Silversmith",
        "Tin Smith": "Tinsmith",
        "White Smith": "Whitesmith",
        "Wheel Wright": "Wheelwright",
        "Mill Wright": "Millwright",
        "Ship Wright": "Shipwright",
        "Post Man": "Postman",
        "Police Man": "Policeman",
        "Milk Man": "Milkman",
        "Bar Man": "Barman",
        "Bar Maid": "Barmaid",
        "House Maid": "Housemaid",
        "Rope Maker": "Ropemaker",
        "Lace Maker": "Lacemaker",
        "Boot Maker": "Bootmaker",
        "Hair Dresser": "Hairdresser",
        "News Agent": "Newsagent",
        "Station Master": "Stationmaster",
        "Post Master": "Postmaster",
        "Post Mistress": "Postmistress",
        "Brick Layer": "Bricklayer",
        "Coach Man": "Coachman",
        "Fisher Man": "Fisherman",
        "Market Gardner": "Market Gardener",
        "Gardner Domestic": "Gardener Domestic",
        "Iron Monger": "Ironmonger",

        // Educational titles
        "School Teacher": "Schoolteacher",
        "National School Teacher": "National Schoolteacher",
        "National School Master": "National Schoolmaster",
        "National School Mistress": "National Schoolmistress",
        "School Master": "Schoolmaster",
        "School Mistress": "Schoolmistress",
        "Hedge School Master": "Hedge Schoolmaster",

        // Standardize servant types
        "General Servant Domestic": "General Domestic Servant",
        "Domestic General Servant": "General Domestic Servant",
        "General Servant, Domestic": "General Domestic Servant",
        "Domestic Servant, General": "General Domestic Servant",
        "Domestic Servant General": "General Domestic Servant",
        "General Servt Domestic": "General Domestic Servant",
        "Genl Servant Domestic": "General Domestic Servant",
        "Gen Servant Domestic": "General Domestic Servant",
        "G Servant Domestic": "General Domestic Servant",
        "Servant Domestic": "Domestic Servant",
        "Domestic Servt": "Domestic Servant",
        "Dom Servant": "Domestic Servant",
        "D Servant": "Domestic Servant",
        "Domestic Servent": "Domestic Servant",
        "Domestic Serveant": "Domestic Servant",
        "Domestick Servant": "Domestic Servant",
        "Domestic servant": "Domestic Servant",
        "Domest Servant": "Domestic Servant",

        // Order corrections
        "Labourer General": "General Labourer",
        "Labourer Agricultural": "Agricultural Labourer",
        "Laborer General": "General Labourer",
        "General Servent": "General Servant",

        // Common spelling corrections
        "Sempstress": "Seamstress",
        "Seamstres": "Seamstress",
        "Seamtress": "Seamstress",
        "Seamsteress": "Seamstress",
        "Seamestress": "Seamstress",
        "Seamsterss": "Seamstress",
        "Seamistress": "Seamstress",
        "Semstress": "Seamstress",
        "Seanstress": "Seamstress",
        "Cleark": "Clerk",
        "Clarke": "Clerk",
        "Clerke": "Clerk",
        "Clerkess": "Clerk",
        "Plumer": "Plumber",
        "Shomaker": "Shoemaker",
        "Miliner": "Milliner",
        "Millner": "Milliner",
        "Laundres": "Laundress",
        "Aprentice": "Apprentice",
        "Serveant": "Servant",
        "At Chool": "At School",
        "Farm Serveant": "Farm Servant",
        "Farme Servant": "Farm Servant",

        // Scholar variants
        "Scholars": "Scholar",
        "Schollar": "Scholar",
        "Scolar": "Scholar",
        "Scholoar": "Scholar",
        "Scholors": "Scholar",
        "Schollars": "Scholar",
        "Schoolar": "Scholar",
        "Scohlar": "Scholar",
        "Scoller": "Scholar",
        "Scollor": "Scholar",
        "Scollar": "Scholar",
        "Scholor": "Scholar",
        "Scholler": "Scholar",
        "Schol": "Scholar",
        "Sholars": "Scholar",
        "Shollar": "Scholar",
        "Sholar": "Scholar",
        "Sclolar": "Scholar",
        "Scoholar": "Scholar",
        "Scholore": "Scholar",
        "Scholour": "Scholar",
        "Schlar": "Scholar",
        "Schalor": "Scholar",
        "Scholl": "Scholar",
        "Shool": "Scholar",

        // Carpenter variants
        "Carpinter": "Carpenter",
        "Carpanter": "Carpenter",
        "Carpentar": "Carpenter",
        "Cartpenter": "Carpenter",
        "Corpenter": "Carpenter",
        "Carpender": "Carpenter",

        // Labourer variants
        "Labourers": "Labourer",
        "Laborour": "Labourer",
        "Labrour": "Labourer",
        "Laboror": "Labourer",
        "Laberour": "Labourer",
        "Labouer": "Labourer",
        "Labour": "Labourer",
        "Labours": "Labourer",
        "Labiour": "Labourer",
        "Labouring": "Labourer",
        "Labrourer": "Labourer",
        "Agricultural Laborer": "Agricultural Labourer",
        "Farm Laborer": "Farm Labourer",
        "General Laborer": "General Labourer",
        "Laborer": "Labourer",

        // Abbreviations
        "Agl Labourer": "Agricultural Labourer",
        "Agrl Labourer": "Agricultural Labourer",
        "Agr Labourer": "Agricultural Labourer",
        "Genl Labourer": "General Labourer",
        "Gen Labourer": "General Labourer",
        "G Labourer": "General Labourer",

        // NEW CORRECTION: Machinist spelling
        "Machinest": "Machinist",
        "Machineist": "Machinist"
    };

    // Apply direct corrections
    if (corrections[corrected]) {
        corrected = corrections[corrected];
    }

    return corrected;
}

// Process batch 7 with complete correction function
const batch7Data = parsedData.data.slice(1800, 2100);
console.log(`Processing batch 7: rows 1801-2100 (${batch7Data.length} rows)`);

const correctedBatch7 = batch7Data.map(row => ({
    occupation: row.occupation,
    count: row.count,
    corrected_occupation: correctOccupation(row.occupation)
}));

// Show corrections made
console.log("\nAll corrections in batch 7:");
let changeCount = 0;
for (let i = 0; i < correctedBatch7.length; i++) {
    const row = correctedBatch7[i];
    if (row.occupation !== row.corrected_occupation) {
        changeCount++;
        console.log(`${1800+i+1}. "${row.occupation}" → "${row.corrected_occupation}" ✓`);
    }
}

console.log(`\nTotal corrections: ${changeCount} out of ${correctedBatch7.length} entries`);

// Check specifically for Machinist corrections
console.log("\nChecking for Machinist-related entries:");
correctedBatch7.forEach((row, index) => {
    if (row.occupation.toLowerCase().includes('machin') || row.corrected_occupation.toLowerCase().includes('machin')) {
        console.log(`${1800+index+1}. "${row.occupation}" → "${row.corrected_occupation}"`);
    }
});

// Generate the CSV for batch 7
const batch7CSV = Papa.unparse(correctedBatch7);
console.log("\n" + "=".repeat(80));
console.log("BATCH 7 CSV OUTPUT (300 ROWS) - CORRECTED VERSION:");
console.log("=".repeat(80));
console.log(batch7CSV);