// STAGE 3: Complete comprehensive correction
import Papa from 'papaparse';
const fileContent = await window.fs.readFile('ire_occupation_1901.csv', { encoding: 'utf8' });

const parsedData = Papa.parse(fileContent, {
    header: true,
    skipEmptyLines: true,
    delimitersToGuess: [',', '\t', '|', ';']
});

const batch8Data = parsedData.data.slice(2100, 2400);

// STAGE 3: Comprehensive correction function with ALL missed items
function correctOccupationStage3(occupation) {
    if (!occupation) return '';

    let corrected = occupation.trim();

    // ENHANCED PREPROCESSING
    corrected = corrected.replace(/[\[\]()]/g, '');
    corrected = corrected.replace(/-/g, ' ');
    corrected = corrected.replace(/\s+/g, ' ').trim();

    // COMPREHENSIVE CORRECTIONS
    const corrections = {
        // Apostrophe corrections - ALL including missed ones
        "Farmers Son": "Farmer's Son",
        "Farmers Daughter": "Farmer's Daughter",
        "Farmers Wife": "Farmer's Wife",
        "Farmers Sister": "Farmer's Sister",
        "Farmers Sister in Law": "Farmer's Sister in Law",
        "Farmers Dauter": "Farmer's Daughter",
        "Farmers Daugt": "Farmer's Daughter",
        "Labourers Wife": "Labourer's Wife",
        "Labourers Daughter": "Labourer's Daughter",
        "Labourers Son": "Labourer's Son",
        "Tailors Daughter": "Tailor's Daughter",
        "Tailors Assistant": "Tailor's Assistant",
        "Tailors Wife": "Tailor's Wife",
        "Policemans Son": "Policeman's Son",
        "Policemans Wife": "Policeman's Wife",
        "Shopkeepers Daughter": "Shopkeeper's Daughter",
        "Shop Keepers Daughter": "Shopkeeper's Daughter",
        "Shop Keepers Wife": "Shopkeeper's Wife",
        "Fishermans Daughter": "Fisherman's Daughter",
        "Childrens Nurse": "Children's Nurse",
        "Childrens Maid": "Children's Maid",
        "Sailors Wife": "Sailor's Wife",
        "Famers Son": "Farmer's Son",
        "Famers Daughter": "Farmer's Daughter",
        "Shepherd Son": "Shepherd's Son",
        "Herd Daughter": "Herd's Daughter",
        "Caretakers Daughter": "Caretaker's Daughter",
        "Farmeress Son": "Farmeress's Son",
        "Farmeress Daughter": "Farmeress's Daughter",
        "Labrs Wife": "Labourer's Wife",

        // Compound words - ALL including missed ones
        "House Keeper": "Housekeeper",
        "Shop Keeper": "Shopkeeper",
        "Chair Maker": "Chairmaker",
        "Paper Maker": "Papermaker",
        "Boat Maker": "Boatmaker",
        "Boot Maker": "Bootmaker",
        "Watch Maker": "Watchmaker",
        "Clock Maker": "Clockmaker",
        "Shoe Maker": "Shoemaker",
        "Dress Maker": "Dressmaker",
        "Cabinet Maker": "Cabinetmaker",
        "Stone Mason": "Stonemason",
        "Black Smith": "Blacksmith",
        "Post Man": "Postman",
        "Police Man": "Policeman",
        "Milk Man": "Milkman",
        "Bar Maid": "Barmaid",
        "House Maid": "Housemaid",
        "Hair Dresser": "Hairdresser",
        "Station Master": "Stationmaster",
        "Post Master": "Postmaster",
        "Brick Layer": "Bricklayer",
        "Coach Man": "Coachman",
        "Fisher Man": "Fisherman",
        "Market Gardner": "Market Gardener",
        "Iron Monger": "Ironmonger",

        // Servant standardization
        "General Servant Domestic": "General Domestic Servant",
        "Gen Servant Domestic": "General Domestic Servant",
        "Genl Servant Domestic": "General Domestic Servant",
        "Servant Domestic": "Domestic Servant",
        "Domestic Servt": "Domestic Servant",
        "Domestic servant": "Domestic Servant",

        // Order corrections
        "Labourer General": "General Labourer",
        "Labourer Agricultural": "Agricultural Labourer",

        // Spelling corrections - ALL including missed ones
        "Cleark": "Clerk",
        "Clarke": "Clerk",
        "Plumer": "Plumber",
        "Plummer": "Plumber",
        "Shomaker": "Shoemaker",
        "Miliner": "Milliner",
        "Laundres": "Laundress",
        "Aprentice": "Apprentice",
        "Serveant": "Servant",
        "Housekeper": "Housekeeper",
        "Seampstress": "Seamstress",
        "Salior": "Sailor",
        "Machanist": "Machinist",

        // Scholar variants
        "Sholor": "Scholar",
        "Scoler": "Scholar",

        // School variants
        "At Shool": "At School",
        "Attending Shool": "Attending School",
        "Attending Scool": "Attending School",

        // Labourer variants
        "Labours": "Labourer",
        "Labiour": "Labourer",
        "Labrourer": "Labourer",

        // Machinist
        "Machinest": "Machinist",
        "Machineist": "Machinist"
    };

    if (corrections[corrected]) {
        corrected = corrections[corrected];
    }

    return corrected;
}

// Reprocess batch 8 with comprehensive Stage 3 corrections
console.log(`STAGE 3 COMPREHENSIVE: Processing batch 8: rows 2101-2400 (${batch8Data.length} rows)`);

const correctedBatch8Final = batch8Data.map(row => ({
    occupation: row.occupation,
    count: row.count,
    corrected_occupation: correctOccupationStage3(row.occupation)
}));

// Show all final corrections
console.log("\nFINAL COMPREHENSIVE BATCH 8 CORRECTIONS:");
let finalChangeCount = 0;
for (let i = 0; i < correctedBatch8Final.length; i++) {
    const row = correctedBatch8Final[i];
    if (row.occupation !== row.corrected_occupation) {
        finalChangeCount++;
        console.log(`${2100+i+1}. "${row.occupation}" → "${row.corrected_occupation}" ✓`);
    }
}

console.log(`\nFinal total corrections: ${finalChangeCount} out of ${correctedBatch8Final.length} entries`);

// Generate final CSV
const batch8FinalCSV = Papa.unparse(correctedBatch8Final);
console.log("\n" + "=".repeat(80));
console.log("FINAL COMPREHENSIVE BATCH 8 CSV OUTPUT (300 ROWS):");
console.log("=".repeat(80));
console.log(batch8FinalCSV);